-- INCREMENTAL LOAD

-- ALTER SESSION TO SET PARAMETER TO ALLOW MULTIPLE INSTANCES OF SAME BUSINESS ID FOR UPDATES IN STAGE
ALTER SESSION SET ERROR_ON_NONDETERMINISTIC_MERGE = FALSE;

-- MERGE RECORDS FROM STAGE
MERGE INTO TPCDI_WH.PUBLIC.FACT_HOLDINGS USING
    (
  SELECT
       HH_H_T_ID TRADE_ID
     , HH_T_ID CURRENT_TRADE_ID
     , DIM_TRADE.SK_CUSTOMER_ID SK_CUSTOMER_ID
     , DIM_TRADE.SK_ACCOUNT_ID SK_ACCOUNT_ID
     , DIM_TRADE.SK_SECURITY_ID SK_SECURITY_ID
     , DIM_TRADE.SK_COMPANY_ID SK_COMPANY_ID
     , DIM_TRADE.SK_CLOSE_DATE_ID SK_DATE_ID
     , DIM_TRADE.SK_CLOSE_TIME_ID SK_TIME_ID
     , DIM_TRADE.TRADE_PRICE CURRENT_PRICE
     , HH_AFTER_QTY CURRENT_HOLDING
     , TO_NUMBER(1) BATCH_ID
  FROM TPCDI_STG.PUBLIC.HOLDINGHISTORY_STG_STM
  INNER JOIN TPCDI_WH.PUBLIC.DIM_TRADE ON
      HOLDINGHISTORY_STG.HH_T_ID = DIM_TRADE.TRADE_ID
    ) HOLDINGS_UPDATES ON FACT_HOLDINGS.CURRENT_TRADE_ID = HOLDINGS_UPDATES.CURRENT_TRADE_ID
WHEN MATCHED THEN UPDATE SET
    FACT_HOLDINGS.TRADE_ID = COALESCE(HOLDINGS_UPDATES.TRADE_ID,FACT_HOLDINGS.TRADE_ID),
    FACT_HOLDINGS.CURRENT_TRADE_ID = COALESCE(HOLDINGS_UPDATES.CURRENT_TRADE_ID,FACT_HOLDINGS.CURRENT_TRADE_ID),
    FACT_HOLDINGS.SK_CUSTOMER_ID = COALESCE(HOLDINGS_UPDATES.SK_CUSTOMER_ID,FACT_HOLDINGS.SK_CUSTOMER_ID),
    FACT_HOLDINGS.SK_ACCOUNT_ID = COALESCE(HOLDINGS_UPDATES.SK_ACCOUNT_ID,FACT_HOLDINGS.SK_ACCOUNT_ID),
    FACT_HOLDINGS.SK_SECURITY_ID = COALESCE(HOLDINGS_UPDATES.SK_SECURITY_ID,FACT_HOLDINGS.SK_SECURITY_ID),
    FACT_HOLDINGS.SK_COMPANY_ID = COALESCE(HOLDINGS_UPDATES.SK_COMPANY_ID,FACT_HOLDINGS.SK_COMPANY_ID),
    FACT_HOLDINGS.SK_DATE_ID = COALESCE(HOLDINGS_UPDATES.SK_DATE_ID,FACT_HOLDINGS.SK_DATE_ID),
    FACT_HOLDINGS.SK_TIME_ID = COALESCE(HOLDINGS_UPDATES.SK_TIME_ID,FACT_HOLDINGS.SK_TIME_ID),
    FACT_HOLDINGS.CURRENT_PRICE = COALESCE(HOLDINGS_UPDATES.CURRENT_PRICE,FACT_HOLDINGS.CURRENT_PRICE),
    FACT_HOLDINGS.CURRENT_HOLDING = COALESCE(HOLDINGS_UPDATES.CURRENT_HOLDING,FACT_HOLDINGS.CURRENT_HOLDING),
    FACT_HOLDINGS.BATCH_ID = COALESCE(HOLDINGS_UPDATES.BATCH_ID,FACT_HOLDINGS.BATCH_ID)
WHEN NOT MATCHED THEN INSERT
VALUES
    ( HOLDINGS_UPDATES.TRADE_ID,
      HOLDINGS_UPDATES.CURRENT_TRADE_ID,
      HOLDINGS_UPDATES.SK_CUSTOMER_ID,
      HOLDINGS_UPDATES.SK_ACCOUNT_ID,
      HOLDINGS_UPDATES.SK_SECURITY_ID,
      HOLDINGS_UPDATES.SK_COMPANY_ID,
      HOLDINGS_UPDATES.SK_DATE_ID,
      HOLDINGS_UPDATES.SK_TIME_ID,
      HOLDINGS_UPDATES.CURRENT_PRICE,
      HOLDINGS_UPDATES.CURRENT_HOLDING,
      HOLDINGS_UPDATES.BATCH_ID
    )
;