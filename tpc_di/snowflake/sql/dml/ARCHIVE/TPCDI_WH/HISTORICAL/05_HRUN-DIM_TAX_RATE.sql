-- DIM_TAX_RATE ONLY REQUIRES AN HISTORICAL LOAD

MERGE INTO TPCDI_WH.PUBLIC.DIM_TAX_RATE USING
(
SELECT
TX_ID
,TX_NAME
,TX_RATE
,METADATA$ACTION
,METADATA$ISUPDATE
FROM TPCDI_STG.PUBLIC.TAXRATE_STG_STM
) TAX_RATE_STG ON TPCDI_WH.PUBLIC.DIM_TAX_RATE.TX_ID = TAX_RATE_STG.TX_ID
WHEN MATCHED AND
TAX_RATE_STG.METADATA$ACTION = 'INSERT' AND TAX_RATE_STG.METADATA$ISUPDATE = 'TRUE'
THEN UPDATE SET
DIM_TAX_RATE.TX_NAME = TAX_RATE_STG.TX_NAME
,DIM_TAX_RATE.TX_RATE = TAX_RATE_STG.TX_RATE
WHEN NOT MATCHED AND
TAX_RATE_STG.METADATA$ACTION = 'INSERT' AND TAX_RATE_STG.METADATA$ISUPDATE = 'FALSE'
THEN INSERT
(
  TX_ID
 ,TX_NAME
 ,TX_RATE
)
VALUES
(
  TAX_RATE_STG.TX_ID
  ,TAX_RATE_STG.TX_NAME
  ,TAX_RATE_STG.TX_RATE
)
;
