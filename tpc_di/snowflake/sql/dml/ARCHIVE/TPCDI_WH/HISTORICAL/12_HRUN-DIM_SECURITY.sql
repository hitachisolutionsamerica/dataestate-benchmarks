-- HISTORICAL LOAD

-- TRUNCATE TABLE
TRUNCATE TABLE TPCDI_WH.PUBLIC.DIM_SECURITY;
COMMIT;

-- RESET SEQUENCE
CREATE OR REPLACE SEQUENCE TPCDI_WH.PUBLIC.DIM_SECURITY_SEQ
START WITH = 1
INCREMENT = 1
COMMENT = 'DATABASE SEQUENCE TO SOURCE THE SURROGATE KEY FOR SECURITY.'
;

-- LOAD TABLE
INSERT INTO TPCDI_WH.PUBLIC.DIM_SECURITY
SELECT
       TPCDI_WH.PUBLIC.DIM_SECURITY_SEQ.NEXTVAL
     , FINWIRE_SEC_ODS_STM.SYMBOL
     , FINWIRE_SEC_ODS_STM.ISSUE_TYPE
     , DIM_STATUS_TYPE.ST_NAME
     , FINWIRE_SEC_ODS_STM.NAME
     , FINWIRE_SEC_ODS_STM.EX_ID
     , COALESCE(ID.SK_COMPANY_ID,NAME.SK_COMPANY_ID)
     , FINWIRE_SEC_ODS_STM.SH_OUT
     , FINWIRE_SEC_ODS_STM.FIRST_TRADE_DATE
     , FINWIRE_SEC_ODS_STM.FIRST_TRADE_EXCHG
     , FINWIRE_SEC_ODS_STM.DIVIDEND
     , TO_NUMBER(1)
     , LOCALTIMESTAMP()
FROM TPCDI_ODS.PUBLIC.FINWIRE_SEC_ODS_STM
INNER JOIN TPCDI_WH.PUBLIC.DIM_STATUS_TYPE ON
    FINWIRE_SEC_ODS_STM.STATUS = DIM_STATUS_TYPE.ST_ID
LEFT OUTER JOIN TPCDI_WH.PUBLIC.DIM_COMPANY_NOW ID ON
    IFF(LTRIM(FINWIRE_SEC_ODS_STM.CO_NAME_OR_CIK,'0')='','0',LTRIM(FINWIRE_SEC_ODS_STM.CO_NAME_OR_CIK,'0')) = ID.COMPANY_ID::STRING
LEFT OUTER JOIN TPCDI_WH.PUBLIC.DIM_COMPANY_NOW NAME ON
    FINWIRE_SEC_ODS_STM.CO_NAME_OR_CIK = NAME.NAME
WHERE FINWIRE_SEC_ODS_STM.METADATA$ACTION = 'INSERT'
;
