-- HISTORICAL LOAD

-- TRUNCATE TABLE
  TRUNCATE TABLE TPCDI_WH.PUBLIC.FACT_WATCHES;
  COMMIT;
  
-- LOAD TABLE
  INSERT INTO TPCDI_WH.PUBLIC.FACT_WATCHES
  SELECT
       DIM_CUSTOMER.SK_CUSTOMER_ID SK_CUSTOMER_ID
     , DIM_SECURITY.SK_SECURITY_ID SK_SECURITY_ID
     , MAX(CASE WHEN WATCH_HISTORY_STG.W_ACTION = 'ACTV' THEN DIM_DATE.DATE_ID END) SK_DATE_ID_DATE_PLACED
     , MAX(CASE WHEN WATCH_HISTORY_STG.W_ACTION = 'CNCL' THEN DIM_DATE.DATE_ID END) SK_DATE_ID_DATE_REMOVED
     , TO_NUMBER(1) BATCH_ID
  FROM TPCDI_STG.PUBLIC.WATCH_HISTORY_STG
  LEFT JOIN TPCDI_WH.PUBLIC.DIM_CUSTOMER ON
      WATCH_HISTORY_STG.W_C_ID = DIM_CUSTOMER.CUSTOMER_ID
  LEFT JOIN TPCDI_WH.PUBLIC.DIM_SECURITY ON
      WATCH_HISTORY_STG.W_S_SYMB = DIM_SECURITY.SYMBOL
  LEFT JOIN TPCDI_WH.PUBLIC.DIM_DATE ON
      TO_DATE(WATCH_HISTORY_STG.W_DTS) = TO_DATE(DIM_DATE.DATE_VALUE)
  GROUP BY
       DIM_CUSTOMER.SK_CUSTOMER_ID
     , DIM_SECURITY.SK_SECURITY_ID
;