-- COMBINATION LOAD
  
-- LOAD TABLE WITH MERGE STATEMENT

MERGE INTO TPCDI_WH.PUBLIC.FACT_PROSPECT USING
  (
  SELECT
  AGENCYID
 ,LASTNAME
 ,FIRSTNAME
 ,MIDDLEINITIAL
 ,GENDER
 ,ADDRESSLINE1
 ,ADDRESSLINE2
 ,POSTALCODE
 ,CITY
 ,STATE
 ,COUNTRY
 ,PHONE
 ,INCOME
 ,NUMBERCARS
 ,NUMBERCHILDREN
 ,MARITALSTATUS
 ,AGE
 ,CREDITRATING
 ,OWNORRENTFLAG
 ,EMPLOYER
 ,NUMBERCREDITCARDS
 ,NETWORTH
 FROM TPCDI_STG.PUBLIC.PROSPECT_STG 
  ) PROSPECT ON TPCDI_WH.PUBLIC.FACT_PROSPECT.AGENCY_ID = PROSPECT.AGENCYID
WHEN MATCHED THEN UPDATE SET
  FACT_PROSPECT.LAST_NAME = PROSPECT.LASTNAME
  ,FACT_PROSPECT.FIRST_NAME = PROSPECT.FIRSTNAME
  ,FACT_PROSPECT.MIDDLE_INITIAL = PROSPECT.MIDDLEINITIAL
  ,FACT_PROSPECT.GENDER = PROSPECT.GENDER
  ,FACT_PROSPECT.ADDRESS_LINE1 = PROSPECT.ADDRESSLINE1
  ,FACT_PROSPECT.ADDRESS_LINE2 = PROSPECT.ADDRESSLINE2
  ,FACT_PROSPECT.POSTAL_CODE = PROSPECT.POSTALCODE
  ,FACT_PROSPECT.CITY = PROSPECT.CITY
  ,FACT_PROSPECT.STATE = PROSPECT.STATE
  ,FACT_PROSPECT.COUNTRY = PROSPECT.COUNTRY
  ,FACT_PROSPECT.PHONE = PROSPECT.PHONE
  ,FACT_PROSPECT.INCOME = PROSPECT.INCOME
  ,FACT_PROSPECT.NUMBER_CARS = PROSPECT.NUMBERCARS
  ,FACT_PROSPECT.NUMBER_CHILDREN = PROSPECT.NUMBERCHILDREN
  ,FACT_PROSPECT.MARITAL_STATUS = PROSPECT.MARITALSTATUS
  ,FACT_PROSPECT.AGE = PROSPECT.AGE
  ,FACT_PROSPECT.CREDIT_RATING = PROSPECT.CREDITRATING
  ,FACT_PROSPECT.OWN_OR_RENT_FLAG = PROSPECT.OWNORRENTFLAG
  ,FACT_PROSPECT.EMPLOYER = PROSPECT.EMPLOYER
  ,FACT_PROSPECT.NUMBER_CREDIT_CARDS = PROSPECT.NUMBERCREDITCARDS
  ,FACT_PROSPECT.NET_WORTH = PROSPECT.NETWORTH
  ,FACT_PROSPECT.SK_UPDATE_DATE_ID = (SELECT MAX(DATE_ID) FROM TPCDI_WH.PUBLIC.DIM_DATE WHERE DATE_VALUE::DATE = CURRENT_DATE())
WHEN NOT MATCHED THEN INSERT
  (
  AGENCY_ID
  ,SK_RECORD_DATE_ID
  ,SK_UPDATE_DATE_ID
  ,BATCH_ID
  ,IS_CUSTOMER
  ,LAST_NAME
  ,FIRST_NAME
  ,MIDDLE_INITIAL
  ,GENDER
  ,ADDRESS_LINE1
  ,ADDRESS_LINE2
  ,POSTAL_CODE
  ,CITY
  ,STATE
  ,COUNTRY
  ,PHONE
  ,INCOME
  ,NUMBER_CARS
  ,NUMBER_CHILDREN
  ,MARITAL_STATUS
  ,AGE
  ,CREDIT_RATING
  ,OWN_OR_RENT_FLAG
  ,EMPLOYER
  ,NUMBER_CREDIT_CARDS
  ,NET_WORTH
  )
VALUES
  (
  PROSPECT.AGENCYID
 ,(SELECT MAX(DATE_ID) FROM TPCDI_WH.PUBLIC.DIM_DATE WHERE DATE_VALUE::DATE = CURRENT_DATE())
 ,(SELECT MAX(DATE_ID) FROM TPCDI_WH.PUBLIC.DIM_DATE WHERE DATE_VALUE::DATE = CURRENT_DATE())
 ,TO_NUMBER(1)
 ,'FALSE'
 ,PROSPECT.LASTNAME
 ,PROSPECT.FIRSTNAME
 ,PROSPECT.MIDDLEINITIAL
 ,PROSPECT.GENDER
 ,PROSPECT.ADDRESSLINE1
 ,PROSPECT.ADDRESSLINE2
 ,PROSPECT.POSTALCODE
 ,PROSPECT.CITY
 ,PROSPECT.STATE
 ,PROSPECT.COUNTRY
 ,PROSPECT.PHONE
 ,PROSPECT.INCOME
 ,PROSPECT.NUMBERCARS
 ,PROSPECT.NUMBERCHILDREN
 ,PROSPECT.MARITALSTATUS
 ,PROSPECT.AGE
 ,PROSPECT.CREDITRATING
 ,PROSPECT.OWNORRENTFLAG
 ,PROSPECT.EMPLOYER
 ,PROSPECT.NUMBERCREDITCARDS
 ,PROSPECT.NETWORTH
  )
;
  
-- PROCESS MARKETING_NAMEPLATE 'HIGHVALUE'
UPDATE TPCDI_WH.PUBLIC.FACT_PROSPECT
SET MARKETING_NAMEPLATE = 'HIGHVALUE'
WHERE
NET_WORTH > 1000000
OR INCOME > 200000
;

-- PROCESS MARKETING_NAMEPLATE 'EXPENSES'
UPDATE TPCDI_WH.PUBLIC.FACT_PROSPECT
SET MARKETING_NAMEPLATE = IFF(MARKETING_NAMEPLATE IS NULL,'EXPENSES',CONCAT(MARKETING_NAMEPLATE,'+EXPENSES'))
WHERE
NUMBER_CHILDREN > 3
OR NUMBER_CREDIT_CARDS > 5
;

-- PROCESS MARKETING_NAMEPLATE 'BOOMER'
UPDATE TPCDI_WH.PUBLIC.FACT_PROSPECT
SET MARKETING_NAMEPLATE = IFF(MARKETING_NAMEPLATE IS NULL,'BOOMER',CONCAT(MARKETING_NAMEPLATE,'+BOOMER'))
WHERE
AGE > 45
;

-- PROCESS MARKETING_NAMEPLATE 'MONEYALERT'
UPDATE TPCDI_WH.PUBLIC.FACT_PROSPECT
SET MARKETING_NAMEPLATE = IFF(MARKETING_NAMEPLATE IS NULL,'MONEYALERT',CONCAT(MARKETING_NAMEPLATE,'+MONEYALERT'))
WHERE
INCOME < 50000
OR CREDIT_RATING < 600
OR NET_WORTH < 100000
;

-- PROCESS MARKETING_NAMEPLATE 'SPENDER'
UPDATE TPCDI_WH.PUBLIC.FACT_PROSPECT
SET MARKETING_NAMEPLATE = IFF(MARKETING_NAMEPLATE IS NULL,'SPENDER',CONCAT(MARKETING_NAMEPLATE,'+SPENDER'))
WHERE
NUMBER_CARS > 3
OR NUMBER_CREDIT_CARDS > 7
;

-- PROCESS MARKETING_NAMEPLATE 'INHERITED'
UPDATE TPCDI_WH.PUBLIC.FACT_PROSPECT
SET MARKETING_NAMEPLATE = IFF(MARKETING_NAMEPLATE IS NULL,'INHERITED',CONCAT(MARKETING_NAMEPLATE,'+INHERITED'))
WHERE
AGE < 25
AND NET_WORTH > 1000000
;

-- UPDATE IS_CUSTOMER FLAG
UPDATE TPCDI_WH.PUBLIC.FACT_PROSPECT T1
SET T1.IS_CUSTOMER = 'TRUE'
FROM TPCDI_WH.PUBLIC.DIM_CUSTOMER T2
WHERE
UPPER(T1.LAST_NAME) = UPPER(T2.LAST_NAME)
AND UPPER(T1.FIRST_NAME) = UPPER(T2.FIRST_NAME)
AND UPPER(T1.ADDRESS_LINE1) = UPPER(T2.ADDRESS_LINE_1)
AND UPPER(T1.ADDRESS_LINE2) = UPPER(T2.ADDRESS_LINE_2)
AND UPPER(T1.POSTAL_CODE) = UPPER(T2.POSTAL_CODE)
AND UPPER(T2.STATUS) = 'ACTIVE'
;
