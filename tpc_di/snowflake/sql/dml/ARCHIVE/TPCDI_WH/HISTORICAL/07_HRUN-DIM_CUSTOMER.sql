-- HISTORICAL LOAD

-- TRUNCATE TABLE
  TRUNCATE TABLE TPCDI_WH.PUBLIC.DIM_CUSTOMER;
  COMMIT;

-- RESET SEQUENCE
  CREATE OR REPLACE SEQUENCE TPCDI_WH.PUBLIC.DIM_CUSTOMER_SEQ
  START WITH = 1
  INCREMENT = 1
  COMMENT = 'DATABASE SEQUENCE TO SOURCE THE SURROGATE KEY FOR CUSTOMER.'
  ;

-- LOAD TABLE
  INSERT INTO TPCDI_WH.PUBLIC.DIM_CUSTOMER
  SELECT
      TPCDI_WH.PUBLIC.DIM_CUSTOMER_SEQ.NEXTVAL --SK_CUSTOMER_ID
     ,CNS.CUSTOMER_ID
     ,CNS.CUSTOMER_TAX_ID
     ,'ACTIVE' --STATUS
     ,CNS.LAST_NAME
     ,CNS.FIRST_NAME
     ,CNS.MIDDLE_INITIAL
     ,CASE WHEN CNS.GENDER = 'M' OR CNS.GENDER = 'F' THEN UPPER(CNS.GENDER) ELSE 'U' END --GENDER
     ,CNS.CUSTOMER_TIER
     ,CNS.DATE_OF_BIRTH
     ,CNS.ADDRESS_LINE_1
     ,CNS.ADDRESS_LINE_2
     ,CNS.ZIP_CODE
     ,CNS.CITY
     ,CNS.STATE_PROVINCE
     ,CNS.COUNTRY
     ,CASE
        WHEN CNS.PHONE_1_COUNTRY_CODE != '' AND CNS.PHONE_1_AREA_CODE != '' AND CNS.PHONE_1_PHONE_NUMBER != '' THEN CNS.PHONE_1_COUNTRY_CODE || '-' || CNS.PHONE_1_AREA_CODE || '-' || CNS.PHONE_1_PHONE_NUMBER
        WHEN CNS.PHONE_1_COUNTRY_CODE = '' AND CNS.PHONE_1_AREA_CODE != '' AND CNS.PHONE_1_PHONE_NUMBER != '' THEN CNS.PHONE_1_AREA_CODE || '-' || CNS.PHONE_1_PHONE_NUMBER
        WHEN CNS.PHONE_1_COUNTRY_CODE = '' AND CNS.PHONE_1_AREA_CODE = '' AND CNS.PHONE_1_PHONE_NUMBER != '' THEN CNS.PHONE_1_PHONE_NUMBER
        ELSE NULL END --PHONE1
     ,CASE
        WHEN CNS.PHONE_2_COUNTRY_CODE != '' AND CNS.PHONE_2_AREA_CODE != '' AND CNS.PHONE_2_PHONE_NUMBER != '' THEN CNS.PHONE_2_COUNTRY_CODE || '-' || CNS.PHONE_2_AREA_CODE || '-' || CNS.PHONE_2_PHONE_NUMBER
        WHEN CNS.PHONE_2_COUNTRY_CODE = '' AND CNS.PHONE_2_AREA_CODE != '' AND CNS.PHONE_2_PHONE_NUMBER != '' THEN CNS.PHONE_2_AREA_CODE || '-' || CNS.PHONE_2_PHONE_NUMBER
        WHEN CNS.PHONE_2_COUNTRY_CODE = '' AND CNS.PHONE_2_AREA_CODE = '' AND CNS.PHONE_2_PHONE_NUMBER != '' THEN CNS.PHONE_2_PHONE_NUMBER
        ELSE NULL END --PHONE2
     ,CASE
        WHEN CNS.PHONE_3_COUNTRY_CODE != '' AND CNS.PHONE_3_AREA_CODE != '' AND CNS.PHONE_3_PHONE_NUMBER != '' THEN CNS.PHONE_3_COUNTRY_CODE || '-' || CNS.PHONE_3_AREA_CODE || '-' || CNS.PHONE_3_PHONE_NUMBER
        WHEN CNS.PHONE_3_COUNTRY_CODE = '' AND CNS.PHONE_3_AREA_CODE != '' AND CNS.PHONE_3_PHONE_NUMBER != '' THEN CNS.PHONE_3_AREA_CODE || '-' || CNS.PHONE_3_PHONE_NUMBER
        WHEN CNS.PHONE_3_COUNTRY_CODE = '' AND CNS.PHONE_3_AREA_CODE = '' AND CNS.PHONE_3_PHONE_NUMBER != '' THEN CNS.PHONE_3_PHONE_NUMBER
        ELSE NULL END --PHONE3
     ,CNS.PRIMARY_EMAIL
     ,CNS.ALTERNATE_EMAIL
     ,NAT_TAX_RATE.TX_NAME --NATIONAL_TAX_RATE_DESC
     ,NAT_TAX_RATE.TX_RATE --NATIONAL_TAX_RATE
     ,LOC_TAX_RATE.TX_NAME --LOCAL_TAX_RATE_DESC
     ,LOC_TAX_RATE.TX_RATE --LOCAL_TAX_RATE
     ,NULL --AGENCY_ID
     ,NULL --CREDIT_RATING
     ,NULL --NET_WORTH
     ,NULL --MARKETING_NAMEPLATE
     ,TO_NUMBER(1) --IS_CURRENT
     ,TO_NUMBER(1) --BATCH_ID
     ,CURRENT_DATE() --EFFECTIVE_DATE
     ,TO_DATE('12/31/3000','MM/DD/YYYY') --END_DATE
  FROM TPCDI_STG.PUBLIC.CUSTOMER_NEW_STG CNS
  INNER JOIN TPCDI_WH.PUBLIC.DIM_TAX_RATE NAT_TAX_RATE ON CNS.NATIONAL_TAX_ID = NAT_TAX_RATE.TX_ID
  INNER JOIN TPCDI_WH.PUBLIC.DIM_TAX_RATE LOC_TAX_RATE ON CNS.LOCAL_TAX_ID = LOC_TAX_RATE.TX_ID
  ;
