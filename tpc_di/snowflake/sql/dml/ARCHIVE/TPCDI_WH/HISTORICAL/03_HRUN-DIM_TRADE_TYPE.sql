-- DIM_TRADE_TYPE ONLY REQUIRES AN HISTORICAL LOAD

MERGE INTO TPCDI_WH.PUBLIC.DIM_TRADE_TYPE USING
(
SELECT
TT_ID
,TT_NAME
,TT_IS_SELL
,TT_IS_MRKT
,METADATA$ACTION
,METADATA$ISUPDATE
FROM TPCDI_STG.PUBLIC.TRADETYPE_STG_STM
) TRADE_TYPE_STG ON TPCDI_WH.PUBLIC.DIM_TRADE_TYPE.TT_ID = TRADE_TYPE_STG.TT_ID
WHEN MATCHED AND
TRADE_TYPE_STG.METADATA$ACTION = 'INSERT' AND TRADE_TYPE_STG.METADATA$ISUPDATE = 'TRUE'
THEN UPDATE SET
DIM_TRADE_TYPE.TT_NAME = TRADE_TYPE_STG.TT_NAME
,DIM_TRADE_TYPE.TT_IS_SELL = TRADE_TYPE_STG.TT_IS_SELL
,DIM_TRADE_TYPE.TT_IS_MRKT = TRADE_TYPE_STG.TT_IS_MRKT
WHEN NOT MATCHED AND
TRADE_TYPE_STG.METADATA$ACTION = 'INSERT' AND TRADE_TYPE_STG.METADATA$ISUPDATE = 'FALSE'
THEN INSERT
(
  TT_ID
  ,TT_NAME
  ,TT_IS_SELL
  ,TT_IS_MRKT
)
VALUES
(
  TRADE_TYPE_STG.TT_ID
  ,TRADE_TYPE_STG.TT_NAME
  ,TRADE_TYPE_STG.TT_IS_SELL
  ,TRADE_TYPE_STG.TT_IS_MRKT
)
;
