-- HISTORICAL LOAD

-- TRUNCATE TABLE
  TRUNCATE TABLE TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY;
  COMMIT;
  
-- LOAD TABLE
  INSERT INTO TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY
  SELECT
       DIM_SECURITY.SK_SECURITY_ID SK_SECURITY_ID
     , DIM_SECURITY.SK_COMPANY_ID SK_COMPANY_ID
     , DIM_DATE.DATE_ID SK_DATE_ID
     , ROUND(COALESCE(DIM_SECURITY.DIVIDEND,0,0,DM_CLOSE / DIM_SECURITY.DIVIDEND),2) PE_RATIO
     , ROUND(COALESCE(DM_CLOSE,0,0,DIM_SECURITY.DIVIDEND / DM_CLOSE) * 100  / 10000 ,2) YIELD 
     , MAX(DM_HIGH) OVER (PARTITION BY DIM_SECURITY.SK_SECURITY_ID) FIFTY_TWO_WEEK_HIGH
     , MAX(DIM_DATE.DATE_ID) OVER (PARTITION BY DIM_SECURITY.SK_SECURITY_ID) SK_FIFTY_TWO_WEEK_HIGH_DATE
     , MIN(DM_LOW) OVER (PARTITION BY DIM_SECURITY.SK_SECURITY_ID)FIFTY_TWO_WEEK_LOW
     , MIN(DIM_DATE.DATE_ID) OVER (PARTITION BY DIM_SECURITY.SK_SECURITY_ID) SK_FIFTY_TWO_WEEK_LOW_DATE
     , DM_CLOSE CLOSE_PRICE
     , DM_HIGH DAY_HIGH
     , DM_LOW DAY_LOW
     , DM_VOL VOLUME
     , TO_NUMBER(1) BATCH_ID
  FROM TPCDI_STG.PUBLIC.DAILYMARKET_STG
LEFT JOIN TPCDI_WH.PUBLIC.DIM_SECURITY ON
      DAILYMARKET_STG.DM_S_SYMB = DIM_SECURITY.SYMBOL
LEFT JOIN TPCDI_WH.PUBLIC.DIM_DATE ON
      TO_DATE(DAILYMARKET_STG.DM_DATE) = TO_DATE(DIM_DATE.DATE_VALUE)
;