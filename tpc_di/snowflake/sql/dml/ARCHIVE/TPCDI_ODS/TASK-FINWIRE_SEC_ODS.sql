CREATE OR REPLACE TASK TPCDI_ODS.PUBLIC.FINWIRE_SEC_ODS_TSK
  WAREHOUSE = TASK_WH,
  SCHEDULE = '1 MINUTE'
AS
MERGE INTO TPCDI_ODS.PUBLIC.FINWIRE_SEC_ODS USING (
  SELECT
      TO_TIMESTAMP_NTZ(PTS,'YYYYMMDD-HH24MISS') AS PTS
      ,REC_TYPE
      ,SYMBOL
      ,ISSUE_TYPE
      ,STATUS
      ,NAME
      ,EX_ID
      ,TO_NUMBER(SH_OUT,13,0) AS SH_OUT
      ,TO_DATE(FIRST_TRADE_DATE,'YYYYMMDD') AS FIRST_TRADE_DATE
      ,TO_DATE(FIRST_TRADE_EXCHG,'YYYYMMDD') AS FIRST_TRADE_EXCHG
      ,TO_NUMBER(DIVIDEND,10,2) AS DIVIDEND
      ,CO_NAME_OR_CIK
      ,METADATA$ACTION
      ,METADATA$ISUPDATE
  FROM TPCDI_STG.PUBLIC.FINWIRE_STG_SEC_STM
  WHERE REC_TYPE = 'SEC'
) FINWIRE_SEC_STG ON TPCDI_ODS.PUBLIC.FINWIRE_SEC_ODS.SYMBOL = FINWIRE_SEC_STG.SYMBOL
WHEN MATCHED THEN UPDATE SET
  FINWIRE_SEC_ODS.PTS = FINWIRE_SEC_STG.PTS
  ,FINWIRE_SEC_ODS.REC_TYPE = FINWIRE_SEC_STG.REC_TYPE
  ,FINWIRE_SEC_ODS.ISSUE_TYPE = FINWIRE_SEC_STG.ISSUE_TYPE
  ,FINWIRE_SEC_ODS.STATUS = FINWIRE_SEC_STG.STATUS
  ,FINWIRE_SEC_ODS.NAME = FINWIRE_SEC_STG.NAME
  ,FINWIRE_SEC_ODS.EX_ID = FINWIRE_SEC_STG.EX_ID
  ,FINWIRE_SEC_ODS.SH_OUT = FINWIRE_SEC_STG.SH_OUT
  ,FINWIRE_SEC_ODS.FIRST_TRADE_DATE = FINWIRE_SEC_STG.FIRST_TRADE_DATE
  ,FINWIRE_SEC_ODS.FIRST_TRADE_EXCHG = FINWIRE_SEC_STG.FIRST_TRADE_EXCHG
  ,FINWIRE_SEC_ODS.DIVIDEND = FINWIRE_SEC_STG.DIVIDEND
  ,FINWIRE_SEC_ODS.CO_NAME_OR_CIK = FINWIRE_SEC_STG.CO_NAME_OR_CIK
  ,FINWIRE_SEC_ODS.LAST_UPDATED_TS = CURRENT_TIMESTAMP()
WHEN NOT MATCHED THEN INSERT
VALUES
(
  FINWIRE_SEC_STG.PTS
  ,FINWIRE_SEC_STG.REC_TYPE
  ,FINWIRE_SEC_STG.SYMBOL
  ,FINWIRE_SEC_STG.ISSUE_TYPE
  ,FINWIRE_SEC_STG.STATUS
  ,FINWIRE_SEC_STG.NAME
  ,FINWIRE_SEC_STG.EX_ID
  ,FINWIRE_SEC_STG.SH_OUT
  ,FINWIRE_SEC_STG.FIRST_TRADE_DATE
  ,FINWIRE_SEC_STG.FIRST_TRADE_EXCHG
  ,FINWIRE_SEC_STG.DIVIDEND
  ,FINWIRE_SEC_STG.CO_NAME_OR_CIK
  ,CURRENT_TIMESTAMP()
)
;

ALTER TASK TPCDI_ODS.PUBLIC.FINWIRE_SEC_ODS_TSK RESUME;
