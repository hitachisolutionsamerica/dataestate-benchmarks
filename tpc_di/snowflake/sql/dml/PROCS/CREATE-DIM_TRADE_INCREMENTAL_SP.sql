CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.DIM_TRADE_INCREMENTAL_SP()
  returns string
  language javascript
  as
  $$
  // Process New Inserts in ODS Table
  var iods_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_ODS.PUBLIC.TRADE_ODS SELECT T_ID, T_DTS, TO_DATE(T_DTS), T_ST_ID, T_TT_ID, T_IS_CASH, T_S_SYMB, T_QTY, T_BID_PRICE, T_CA_ID, T_EXEC_NAME, T_TRADE_PRICE, T_CHRG, T_COMM, T_TAX, CURRENT_TIMESTAMP() FROM TPCDI_STG.PUBLIC.TRADE_STG_I_STM WHERE CDC_FLAG = 'I' "}
      );
  iods_stmt.execute();
  // Log audit record
  var audit1_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'DIM_TRADE_INCREMENTAL_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, 0 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit1_stmt.execute();
  // Process Dimension Table
  var dim1_stmt = snowflake.createStatement(
      {sqlText: "CALL TPCDI_WH.PUBLIC.DIM_TRADE_SP() "}
      );
  dim1_stmt.execute();
  // Process Submits in ODS Table
  var sods_stmt = snowflake.createStatement(
      {sqlText: "UPDATE TPCDI_ODS.PUBLIC.TRADE_ODS SET TRADE_ODS.T_DTS = COALESCE(TS.T_DTS,TRADE_ODS.T_DTS), TRADE_ODS.T_DT = COALESCE(TO_DATE(TS.T_DTS),TRADE_ODS.T_DTS), TRADE_ODS.T_ST_ID = COALESCE(TS.T_ST_ID,TRADE_ODS.T_ST_ID), TRADE_ODS.T_TT_ID = COALESCE(TS.T_TT_ID,TRADE_ODS.T_TT_ID), TRADE_ODS.T_IS_CASH = COALESCE(TS.T_IS_CASH,TRADE_ODS.T_IS_CASH), TRADE_ODS.T_S_SYMB = COALESCE(TS.T_S_SYMB,TRADE_ODS.T_S_SYMB), TRADE_ODS.T_QTY = COALESCE(TS.T_QTY,TRADE_ODS.T_QTY), TRADE_ODS.T_BID_PRICE = COALESCE(TS.T_BID_PRICE,TRADE_ODS.T_BID_PRICE), TRADE_ODS.T_CA_ID = COALESCE(TS.T_CA_ID,TRADE_ODS.T_CA_ID), TRADE_ODS.T_EXEC_NAME = COALESCE(TS.T_EXEC_NAME,TRADE_ODS.T_EXEC_NAME), TRADE_ODS.T_TRADE_PRICE = COALESCE(TS.T_TRADE_PRICE,TRADE_ODS.T_TRADE_PRICE), TRADE_ODS.T_CHRG = COALESCE(TS.T_CHRG,TRADE_ODS.T_CHRG), TRADE_ODS.T_COMM = COALESCE(TS.T_COMM,TRADE_ODS.T_COMM), TRADE_ODS.T_TAX = COALESCE(TS.T_TAX,TRADE_ODS.T_TAX), TRADE_ODS.LAST_UPDATED_TS = CURRENT_TIMESTAMP() FROM TPCDI_STG.PUBLIC.TRADE_STG_US_STM TS WHERE TS.CDC_FLAG = 'U' AND TS.T_ST_ID = 'SBMT' AND TRADE_ODS.T_ID = TS.T_ID"}
      );
  sods_stmt.execute();
  // Log audit record
  var audit2_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'DIM_TRADE_INCREMENTAL_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), 0, $1 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit2_stmt.execute();
  // Process Dimension Table
  var dim2_stmt = snowflake.createStatement(
      {sqlText: "CALL TPCDI_WH.PUBLIC.DIM_TRADE_SP() "}
      );
  dim2_stmt.execute();
  // Process Closed or Cancelled in ODS Table
  var cods_stmt = snowflake.createStatement(
      {sqlText: "UPDATE TPCDI_ODS.PUBLIC.TRADE_ODS SET TRADE_ODS.T_DTS = COALESCE(TS.T_DTS,TRADE_ODS.T_DTS), TRADE_ODS.T_DT = COALESCE(TO_DATE(TS.T_DTS),TRADE_ODS.T_DTS), TRADE_ODS.T_ST_ID = COALESCE(TS.T_ST_ID,TRADE_ODS.T_ST_ID), TRADE_ODS.T_TT_ID = COALESCE(TS.T_TT_ID,TRADE_ODS.T_TT_ID), TRADE_ODS.T_IS_CASH = COALESCE(TS.T_IS_CASH,TRADE_ODS.T_IS_CASH), TRADE_ODS.T_S_SYMB = COALESCE(TS.T_S_SYMB,TRADE_ODS.T_S_SYMB), TRADE_ODS.T_QTY = COALESCE(TS.T_QTY,TRADE_ODS.T_QTY), TRADE_ODS.T_BID_PRICE = COALESCE(TS.T_BID_PRICE,TRADE_ODS.T_BID_PRICE), TRADE_ODS.T_CA_ID = COALESCE(TS.T_CA_ID,TRADE_ODS.T_CA_ID), TRADE_ODS.T_EXEC_NAME = COALESCE(TS.T_EXEC_NAME,TRADE_ODS.T_EXEC_NAME), TRADE_ODS.T_TRADE_PRICE = COALESCE(TS.T_TRADE_PRICE,TRADE_ODS.T_TRADE_PRICE), TRADE_ODS.T_CHRG = COALESCE(TS.T_CHRG,TRADE_ODS.T_CHRG), TRADE_ODS.T_COMM = COALESCE(TS.T_COMM,TRADE_ODS.T_COMM), TRADE_ODS.T_TAX = COALESCE(TS.T_TAX,TRADE_ODS.T_TAX), TRADE_ODS.LAST_UPDATED_TS = CURRENT_TIMESTAMP() FROM TPCDI_STG.PUBLIC.TRADE_STG_UC_STM TS WHERE TS.CDC_FLAG = 'U' AND TS.T_ST_ID in ('CMPT','CNCL') AND TRADE_ODS.T_ID = TS.T_ID "}
      );
  cods_stmt.execute();
  // Log audit record
  var audit3_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'DIM_TRADE_INCREMENTAL_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), 0, $1 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit3_stmt.execute();
  // Process Dimension Table
  var dim3_stmt = snowflake.createStatement(
      {sqlText: "CALL TPCDI_WH.PUBLIC.DIM_TRADE_SP() "}
      );
  dim3_stmt.execute();
  return 'Dim Trade incremental records have been processed.';
  $$
;
