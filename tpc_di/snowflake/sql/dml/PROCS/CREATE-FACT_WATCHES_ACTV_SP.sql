CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.FACT_WATCHES_ACTV_SP()
  returns string
  language javascript
  as
  $$
  // Process Fact Table
  var trans_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.FACT_WATCHES SELECT DIM_CUSTOMER_NOW.SK_CUSTOMER_ID SK_CUSTOMER_ID, DIM_SECURITY_NOW.SK_SECURITY_ID SK_SECURITY_ID, DIM_DATE.DATE_ID SK_DATE_ID_DATE_PLACED, NULL SK_DATE_ID_DATE_REMOVED, (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH) BATCH_ID FROM TPCDI_STG.PUBLIC.WATCH_HISTORY_STG_ACTV_STM INNER JOIN TPCDI_WH.PUBLIC.DIM_CUSTOMER_NOW ON WATCH_HISTORY_STG_ACTV_STM.W_C_ID = DIM_CUSTOMER_NOW.CUSTOMER_ID INNER JOIN TPCDI_WH.PUBLIC.DIM_SECURITY_NOW ON WATCH_HISTORY_STG_ACTV_STM.W_S_SYMB = DIM_SECURITY_NOW.SYMBOL INNER JOIN TPCDI_WH.PUBLIC.DIM_DATE ON TO_DATE(WATCH_HISTORY_STG_ACTV_STM.W_DTS) = TO_DATE(DIM_DATE.DATE_VALUE) WHERE WATCH_HISTORY_STG_ACTV_STM.W_ACTION = 'ACTV' "}
    );
  trans_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'FACT_WATCHES_ACTV_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, 0 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
      );
  audit_stmt.execute();
  return 'Fact Watches active transactions processed.';
  $$
;
