CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.FACT_WATCHES_CNCL_SP()
  returns string
  language javascript
  as
  $$
  // Process Fact Table
  var trans_stmt = snowflake.createStatement(
      {sqlText: "UPDATE TPCDI_WH.PUBLIC.FACT_WATCHES SET FACT_WATCHES.SK_DATE_ID_DATE_REMOVED = ALL_CUST_SEC_SK.SK_DATE_ID_DATE_REMOVED FROM (SELECT DIM_CUSTOMER.SK_CUSTOMER_ID SK_CUSTOMER_ID, DIM_SECURITY.SK_SECURITY_ID SK_SECURITY_ID, DIM_DATE.DATE_ID SK_DATE_ID_DATE_REMOVED FROM TPCDI_STG.PUBLIC.WATCH_HISTORY_STG_CNCL_STM INNER JOIN TPCDI_WH.PUBLIC.DIM_CUSTOMER ON       WATCH_HISTORY_STG_CNCL_STM.W_C_ID = DIM_CUSTOMER.CUSTOMER_ID INNER JOIN TPCDI_WH.PUBLIC.DIM_SECURITY ON       WATCH_HISTORY_STG_CNCL_STM.W_S_SYMB = DIM_SECURITY.SYMBOL INNER JOIN TPCDI_WH.PUBLIC.DIM_DATE ON       TO_DATE(WATCH_HISTORY_STG_CNCL_STM.W_DTS) = TO_DATE(DIM_DATE.DATE_VALUE) WHERE WATCH_HISTORY_STG_CNCL_STM.W_ACTION = 'CNCL') ALL_CUST_SEC_SK WHERE FACT_WATCHES.SK_CUSTOMER_ID = ALL_CUST_SEC_SK.SK_CUSTOMER_ID  AND FACT_WATCHES.SK_SECURITY_ID = ALL_CUST_SEC_SK.SK_SECURITY_ID AND FACT_WATCHES.SK_DATE_ID_DATE_REMOVED IS NULL "}
    );
  trans_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'FACT_WATCHES_CNCL_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), 0, $1 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
      );
  audit_stmt.execute();
  return 'Fact Watches cancelled transactions processed.';
  $$
;

