CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.FACT_CASH_BALANCES_INCREMENTAL_SP()
  returns string
  language javascript
  as
  $$
  // Process Transactions
  var fact_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.FACT_CASH_BALANCES SELECT DIM_ACCOUNT_NOW.SK_CUSTOMER_ID, DIM_ACCOUNT_NOW.SK_ACCOUNT_ID, DIM_DATE.DATE_ID, CASHTRANSACTION_STG_STM_Q.NEW_CASH + IFNULL(CASHTRANSACTION_STG_STM_Q.LAST_CASH,0), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH) FROM (WITH GET_LAST_BALANCE AS (SELECT DISTINCT DIM_ACCOUNT_NOW.ACCOUNT_ID ACCOUNT_ID, LAST_VALUE(FACT_CASH_BALANCES.SK_DATE_ID) OVER (PARTITION BY FACT_CASH_BALANCES.SK_CUSTOMER_ID, FACT_CASH_BALANCES.SK_ACCOUNT_ID ORDER BY FACT_CASH_BALANCES.SK_DATE_ID) AS LAST_SK_DATE_ID, LAST_VALUE(FACT_CASH_BALANCES.CASH) OVER (PARTITION BY FACT_CASH_BALANCES.SK_CUSTOMER_ID, FACT_CASH_BALANCES.SK_ACCOUNT_ID ORDER BY FACT_CASH_BALANCES.SK_DATE_ID) AS LAST_CASH FROM TPCDI_WH.PUBLIC.FACT_CASH_BALANCES INNER JOIN TPCDI_WH.PUBLIC.DIM_ACCOUNT_NOW ON         FACT_CASH_BALANCES.SK_ACCOUNT_ID = DIM_ACCOUNT_NOW.SK_ACCOUNT_ID) SELECT CASHTRANSACTION_STG_STM.CT_CA_ID, TO_DATE(CASHTRANSACTION_STG_STM.CT_DTS) AS DATE, SUM(CASHTRANSACTION_STG_STM.CT_AMT) AS NEW_CASH, MAX(GET_LAST_BALANCE.LAST_CASH) AS LAST_CASH FROM TPCDI_STG.PUBLIC.CASHTRANSACTION_STG_STM INNER JOIN GET_LAST_BALANCE ON CASHTRANSACTION_STG_STM.CT_CA_ID = GET_LAST_BALANCE.ACCOUNT_ID GROUP BY 1,2) CASHTRANSACTION_STG_STM_Q INNER JOIN TPCDI_WH.PUBLIC.DIM_ACCOUNT_NOW ON CASHTRANSACTION_STG_STM_Q.CT_CA_ID = DIM_ACCOUNT_NOW.ACCOUNT_ID INNER JOIN TPCDI_WH.PUBLIC.DIM_DATE ON CASHTRANSACTION_STG_STM_Q.DATE = DIM_DATE.DATE_VALUE"}
      );
  fact_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'FACT_CASH_BALANCES_INCREMENTAL_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, 0 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
      );
  audit_stmt.execute();
  return 'Fact Cash Balances transactions inserted.';
  $$
;  

