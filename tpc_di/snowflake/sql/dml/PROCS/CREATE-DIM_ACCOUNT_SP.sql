CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.DIM_ACCOUNT_SP()
  returns string
  language javascript
  as
  $$
  // Process Dimension Table
  var dim_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.DIM_ACCOUNT SELECT TPCDI_WH.PUBLIC.DIM_ACCOUNT_SEQ.NEXTVAL AS SK_ACCOUNT_ID, A.CA_ID, COALESCE(DIM_BROKER.SK_BROKER_ID,0), DIM_CUSTOMER_NOW.SK_CUSTOMER_ID, A.CA_ST_ID, A.CA_NAME, A.CA_TAX_ST, (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH) AS BATCH_ID, LOCALTIMESTAMP() AS INSERTED_TS FROM TPCDI_ODS.PUBLIC.ACCOUNT_ODS_STM A LEFT OUTER JOIN TPCDI_WH.PUBLIC.DIM_BROKER ON A.CA_B_ID = DIM_BROKER.BROKER_ID INNER JOIN TPCDI_WH.PUBLIC.DIM_CUSTOMER_NOW ON A.CA_C_ID = DIM_CUSTOMER_NOW.CUSTOMER_ID WHERE A.METADATA$ACTION = 'INSERT'"}
      );
  dim_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'DIM_ACCOUNT_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, 0 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
      );
  audit_stmt.execute();
  return 'Dim Account records processed.';
  $$
;
