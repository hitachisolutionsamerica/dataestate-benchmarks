CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.CUSTOMER_UPDT_ODS_SP()
  returns string
  language javascript
  as
  $$
  // Process ODS Table
  var stmt = snowflake.createStatement(
      {sqlText: "UPDATE TPCDI_ODS.PUBLIC.CUSTOMER_ODS ODS SET ODS.C_TIER = COALESCE(CUS.C_TIER,ODS.C_TIER), ODS.C_ADLINE1 = COALESCE(CUS.ADDRESSLINE1,ODS.C_ADLINE1), ODS.C_ADLINE2 = COALESCE(CUS.ADDRESSLINE2,ODS.C_ADLINE2), ODS.C_ZIPCODE = COALESCE(CUS.ZIPCODE,ODS.C_ZIPCODE), ODS.C_CITY = COALESCE(CUS.CITY,ODS.C_CITY), ODS.C_STATE_PROV = COALESCE(CUS.STATEPROV,ODS.C_STATE_PROV), ODS.C_CTRY = COALESCE(CUS.COUNTRY,ODS.C_CTRY), ODS.C_CTRY_1 = COALESCE(CUS.PH1COUNTRYCODE,ODS.C_CTRY_1), ODS.C_AREA_1 = COALESCE(CUS.PH1AREACODE,ODS.C_AREA_1), ODS.C_LOCAL_1 = COALESCE(CUS.PH1LOCALNUMBER,ODS.C_LOCAL_1), ODS.C_EXT_1 = COALESCE(CUS.PH1EXTENSION,ODS.C_EXT_1), ODS.C_CTRY_2 = COALESCE(CUS.PH2COUNTRYCODE,ODS.C_CTRY_2), ODS.C_AREA_2 = COALESCE(CUS.PH2AREACODE,ODS.C_AREA_2), ODS.C_LOCAL_2 = COALESCE(CUS.PH2LOCALNUMBER,ODS.C_LOCAL_2), ODS.C_EXT_2 = COALESCE(CUS.PH2EXTENSION,ODS.C_EXT_2), ODS.C_CTRY_3 = COALESCE(CUS.PH3COUNTRYCODE,ODS.C_CTRY_3), ODS.C_AREA_3 = COALESCE(CUS.PH3AREACODE,ODS.C_AREA_3), ODS.C_LOCAL_3 = COALESCE(CUS.PH3LOCALNUMBER,ODS.C_LOCAL_3), ODS.C_EXT_3 = COALESCE(CUS.PH3EXTENSION,ODS.C_EXT_3), ODS.C_EMAIL_1 = COALESCE(CUS.PRIMARYEMAIL,ODS.C_EMAIL_1), ODS.C_EMAIL_2 = COALESCE(CUS.ALTERNATEEMAIL,ODS.C_EMAIL_2), ODS.LAST_UPDATED_TS = CURRENT_TIMESTAMP() FROM TPCDI_STG.PUBLIC.CUSTOMER_UPDT_STG CUS WHERE CUS.C_ID = ODS.C_ID"}
    );
  stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'CUSTOMER_UPDT_ODS_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), 0, $1 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit_stmt.execute();
  return 'Customer ODS records updated.';
  $$
;
