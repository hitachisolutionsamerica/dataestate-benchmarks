CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.FACT_PROSPECT_TRANS_SP()
  returns string
  language javascript
  as
  $$
  // Process Fact Table
  var fact_stmt = snowflake.createStatement(
      {sqlText: "MERGE INTO TPCDI_WH.PUBLIC.FACT_PROSPECT USING ( SELECT AGENCYID, LASTNAME, FIRSTNAME, MIDDLEINITIAL, GENDER, ADDRESSLINE1, ADDRESSLINE2, POSTALCODE, CITY, STATE, COUNTRY, PHONE, INCOME, NUMBERCARS, NUMBERCHILDREN, MARITALSTATUS, AGE, CREDITRATING, OWNORRENTFLAG, EMPLOYER, NUMBERCREDITCARDS, NETWORTH FROM TPCDI_STG.PUBLIC.PROSPECT_STG_STM) PROSPECT ON TPCDI_WH.PUBLIC.FACT_PROSPECT.AGENCY_ID = PROSPECT.AGENCYID WHEN MATCHED THEN UPDATE SET FACT_PROSPECT.LAST_NAME = PROSPECT.LASTNAME ,FACT_PROSPECT.FIRST_NAME = PROSPECT.FIRSTNAME, FACT_PROSPECT.MIDDLE_INITIAL = PROSPECT.MIDDLEINITIAL, FACT_PROSPECT.GENDER = PROSPECT.GENDER, FACT_PROSPECT.ADDRESS_LINE1 = PROSPECT.ADDRESSLINE1, FACT_PROSPECT.ADDRESS_LINE2 = PROSPECT.ADDRESSLINE2, FACT_PROSPECT.POSTAL_CODE = PROSPECT.POSTALCODE, FACT_PROSPECT.CITY = PROSPECT.CITY, FACT_PROSPECT.STATE = PROSPECT.STATE, FACT_PROSPECT.COUNTRY = PROSPECT.COUNTRY, FACT_PROSPECT.PHONE = PROSPECT.PHONE, FACT_PROSPECT.INCOME = PROSPECT.INCOME, FACT_PROSPECT.NUMBER_CARS = PROSPECT.NUMBERCARS, FACT_PROSPECT.NUMBER_CHILDREN = PROSPECT.NUMBERCHILDREN, FACT_PROSPECT.MARITAL_STATUS = PROSPECT.MARITALSTATUS, FACT_PROSPECT.AGE = PROSPECT.AGE, FACT_PROSPECT.CREDIT_RATING = PROSPECT.CREDITRATING, FACT_PROSPECT.OWN_OR_RENT_FLAG = PROSPECT.OWNORRENTFLAG, FACT_PROSPECT.EMPLOYER = PROSPECT.EMPLOYER, FACT_PROSPECT.NUMBER_CREDIT_CARDS = PROSPECT.NUMBERCREDITCARDS, FACT_PROSPECT.NET_WORTH = PROSPECT.NETWORTH, FACT_PROSPECT.SK_UPDATE_DATE_ID = (SELECT MAX(DATE_ID) FROM TPCDI_WH.PUBLIC.DIM_DATE WHERE DATE_VALUE::DATE = CURRENT_DATE()) WHEN NOT MATCHED THEN INSERT (AGENCY_ID, SK_RECORD_DATE_ID, SK_UPDATE_DATE_ID, BATCH_ID, IS_CUSTOMER, LAST_NAME, FIRST_NAME, MIDDLE_INITIAL, GENDER, ADDRESS_LINE1, ADDRESS_LINE2, POSTAL_CODE, CITY, STATE, COUNTRY, PHONE, INCOME, NUMBER_CARS, NUMBER_CHILDREN, MARITAL_STATUS, AGE, CREDIT_RATING, OWN_OR_RENT_FLAG, EMPLOYER, NUMBER_CREDIT_CARDS, NET_WORTH) VALUES (PROSPECT.AGENCYID, (SELECT MAX(DATE_ID) FROM TPCDI_WH.PUBLIC.DIM_DATE WHERE DATE_VALUE::DATE = CURRENT_DATE()), (SELECT MAX(DATE_ID) FROM TPCDI_WH.PUBLIC.DIM_DATE WHERE DATE_VALUE::DATE = CURRENT_DATE()), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), 'FALSE', PROSPECT.LASTNAME, PROSPECT.FIRSTNAME, PROSPECT.MIDDLEINITIAL, PROSPECT.GENDER, PROSPECT.ADDRESSLINE1, PROSPECT.ADDRESSLINE2, PROSPECT.POSTALCODE, PROSPECT.CITY, PROSPECT.STATE, PROSPECT.COUNTRY, PROSPECT.PHONE, PROSPECT.INCOME, PROSPECT.NUMBERCARS, PROSPECT.NUMBERCHILDREN, PROSPECT.MARITALSTATUS, PROSPECT.AGE, PROSPECT.CREDITRATING, PROSPECT.OWNORRENTFLAG, PROSPECT.EMPLOYER, PROSPECT.NUMBERCREDITCARDS, PROSPECT.NETWORTH)"}
    );
  fact_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'FACT_PROSPECT_TRANS_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, $2 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit_stmt.execute();
  return 'Fact Prospect transactions loaded.';
  $$
;
