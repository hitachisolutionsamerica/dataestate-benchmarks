CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.DIM_TRADE_TYPE_HISTORICAL_SP()
  returns string
  language javascript
  as
  $$
  // Process Dimension Table Updates
  var dim_stmt = snowflake.createStatement(
      {sqlText: "MERGE INTO TPCDI_WH.PUBLIC.DIM_TRADE_TYPE USING (SELECT TT_ID, TT_NAME, TT_IS_SELL, TT_IS_MRKT, METADATA$ACTION, METADATA$ISUPDATE FROM TPCDI_STG.PUBLIC.TRADETYPE_STG_STM ) TRADE_TYPE_STG ON TPCDI_WH.PUBLIC.DIM_TRADE_TYPE.TT_ID = TRADE_TYPE_STG.TT_ID WHEN MATCHED AND TRADE_TYPE_STG.METADATA$ACTION = 'INSERT' AND TRADE_TYPE_STG.METADATA$ISUPDATE = 'TRUE' THEN UPDATE SET DIM_TRADE_TYPE.TT_NAME = TRADE_TYPE_STG.TT_NAME, DIM_TRADE_TYPE.TT_IS_SELL = TRADE_TYPE_STG.TT_IS_SELL, DIM_TRADE_TYPE.TT_IS_MRKT = TRADE_TYPE_STG.TT_IS_MRKT WHEN NOT MATCHED AND TRADE_TYPE_STG.METADATA$ACTION = 'INSERT' AND TRADE_TYPE_STG.METADATA$ISUPDATE = 'FALSE' THEN INSERT (TT_ID, TT_NAME, TT_IS_SELL, TT_IS_MRKT) VALUES (TRADE_TYPE_STG.TT_ID, TRADE_TYPE_STG.TT_NAME, TRADE_TYPE_STG.TT_IS_SELL, TRADE_TYPE_STG.TT_IS_MRKT)"}
    );
  dim_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'DIM_TRADE_TYPE_HISTORICAL_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, $2 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit_stmt.execute();
  return "Dim Trade Type records processed.";
  $$
;
