CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.CUSTOMER_ODS_SP()
  returns string
  language javascript
  as
  $$
  // Process ODS Table
  var stmt = snowflake.createStatement(
      {sqlText: "MERGE INTO TPCDI_ODS.PUBLIC.CUSTOMER_ODS USING (SELECT CDC_FLAG, CDC_DSN, C_ID, C_TAX_ID, C_ST_ID, C_L_NAME, C_F_NAME, C_M_NAME, C_GNDR, C_TIER, C_DOB, C_ADLINE1, C_ADLINE2, C_ZIPCODE, C_CITY, C_STATE_PROV, C_CTRY, C_CTRY_1, C_AREA_1, C_LOCAL_1, C_EXT_1, C_CTRY_2, C_AREA_2, C_LOCAL_2, C_EXT_2, C_CTRY_3, C_AREA_3, C_LOCAL_3, C_EXT_3, C_EMAIL_1, C_EMAIL_2, C_LCL_TX_ID, C_NAT_TX_ID, METADATA$ACTION, METADATA$ISUPDATE FROM TPCDI_STG.PUBLIC.CUSTOMER_STG_STM) CUSTOMER_STG ON TPCDI_ODS.PUBLIC.CUSTOMER_ODS.C_ID = CUSTOMER_STG.C_ID WHEN MATCHED AND CUSTOMER_STG.CDC_FLAG = 'U' THEN UPDATE SET CUSTOMER_ODS.C_TAX_ID = COALESCE(CUSTOMER_STG.C_TAX_ID,CUSTOMER_ODS.C_TAX_ID), CUSTOMER_ODS.C_ST_ID = COALESCE(CUSTOMER_STG.C_ST_ID,CUSTOMER_ODS.C_ST_ID), CUSTOMER_ODS.C_L_NAME = COALESCE(CUSTOMER_STG.C_L_NAME,CUSTOMER_ODS.C_L_NAME), CUSTOMER_ODS.C_F_NAME = COALESCE(CUSTOMER_STG.C_F_NAME,CUSTOMER_ODS.C_F_NAME), CUSTOMER_ODS.C_M_NAME = COALESCE(CUSTOMER_STG.C_M_NAME,CUSTOMER_ODS.C_M_NAME), CUSTOMER_ODS.C_GNDR = COALESCE(CUSTOMER_STG.C_GNDR,CUSTOMER_ODS.C_GNDR), CUSTOMER_ODS.C_TIER = COALESCE(CUSTOMER_STG.C_TIER,CUSTOMER_ODS.C_TIER), CUSTOMER_ODS.C_DOB = COALESCE(CUSTOMER_STG.C_DOB,CUSTOMER_ODS.C_DOB), CUSTOMER_ODS.C_ADLINE1 = COALESCE(CUSTOMER_STG.C_ADLINE1,CUSTOMER_ODS.C_ADLINE1), CUSTOMER_ODS.C_ADLINE2 = COALESCE(CUSTOMER_STG.C_ADLINE2,CUSTOMER_ODS.C_ADLINE2), CUSTOMER_ODS.C_ZIPCODE = COALESCE(CUSTOMER_STG.C_ZIPCODE,CUSTOMER_ODS.C_ZIPCODE), CUSTOMER_ODS.C_CITY = COALESCE(CUSTOMER_STG.C_CITY,CUSTOMER_ODS.C_CITY), CUSTOMER_ODS.C_STATE_PROV = COALESCE(CUSTOMER_STG.C_STATE_PROV,CUSTOMER_ODS.C_STATE_PROV), CUSTOMER_ODS.C_CTRY = COALESCE(CUSTOMER_STG.C_CTRY,CUSTOMER_ODS.C_CTRY), CUSTOMER_ODS.C_CTRY_1 = COALESCE(CUSTOMER_STG.C_CTRY_1,CUSTOMER_ODS.C_CTRY_1), CUSTOMER_ODS.C_AREA_1 = COALESCE(CUSTOMER_STG.C_AREA_1,CUSTOMER_ODS.C_AREA_1), CUSTOMER_ODS.C_LOCAL_1 = COALESCE(CUSTOMER_STG.C_LOCAL_1,CUSTOMER_ODS.C_LOCAL_1), CUSTOMER_ODS.C_EXT_1 = COALESCE(CUSTOMER_STG.C_EXT_1,CUSTOMER_ODS.C_EXT_1), CUSTOMER_ODS.C_CTRY_2 = COALESCE(CUSTOMER_STG.C_CTRY_2,CUSTOMER_ODS.C_CTRY_2), CUSTOMER_ODS.C_AREA_2 = COALESCE(CUSTOMER_STG.C_AREA_2,CUSTOMER_ODS.C_AREA_2), CUSTOMER_ODS.C_LOCAL_2 = COALESCE(CUSTOMER_STG.C_LOCAL_2,CUSTOMER_ODS.C_LOCAL_2), CUSTOMER_ODS.C_EXT_2 = COALESCE(CUSTOMER_STG.C_EXT_2,CUSTOMER_ODS.C_EXT_2), CUSTOMER_ODS.C_CTRY_3 = COALESCE(CUSTOMER_STG.C_CTRY_3,CUSTOMER_ODS.C_CTRY_3), CUSTOMER_ODS.C_AREA_3 = COALESCE(CUSTOMER_STG.C_AREA_3,CUSTOMER_ODS.C_AREA_3), CUSTOMER_ODS.C_LOCAL_3 = COALESCE(CUSTOMER_STG.C_LOCAL_3,CUSTOMER_ODS.C_LOCAL_3), CUSTOMER_ODS.C_EXT_3 = COALESCE(CUSTOMER_STG.C_EXT_3,CUSTOMER_ODS.C_EXT_3), CUSTOMER_ODS.C_EMAIL_1 = COALESCE(CUSTOMER_STG.C_EMAIL_1,CUSTOMER_ODS.C_EMAIL_1), CUSTOMER_ODS.C_EMAIL_2 = COALESCE(CUSTOMER_STG.C_EMAIL_2,CUSTOMER_ODS.C_EMAIL_2), CUSTOMER_ODS.C_LCL_TX_ID = COALESCE(CUSTOMER_STG.C_LCL_TX_ID,CUSTOMER_ODS.C_LCL_TX_ID), CUSTOMER_ODS.C_NAT_TX_ID = COALESCE(CUSTOMER_STG.C_NAT_TX_ID,CUSTOMER_ODS.C_NAT_TX_ID), CUSTOMER_ODS.LAST_UPDATED_TS = CURRENT_TIMESTAMP() WHEN NOT MATCHED AND CUSTOMER_STG.CDC_FLAG = 'I' THEN INSERT VALUES (CUSTOMER_STG.C_ID, CUSTOMER_STG.C_TAX_ID, CUSTOMER_STG.C_ST_ID, CUSTOMER_STG.C_L_NAME, CUSTOMER_STG.C_F_NAME, CUSTOMER_STG.C_M_NAME, CUSTOMER_STG.C_GNDR, CUSTOMER_STG.C_TIER, CUSTOMER_STG.C_DOB, CUSTOMER_STG.C_ADLINE1, CUSTOMER_STG.C_ADLINE2, CUSTOMER_STG.C_ZIPCODE, CUSTOMER_STG.C_CITY, CUSTOMER_STG.C_STATE_PROV, CUSTOMER_STG.C_CTRY, CUSTOMER_STG.C_CTRY_1, CUSTOMER_STG.C_AREA_1, CUSTOMER_STG.C_LOCAL_1, CUSTOMER_STG.C_EXT_1, CUSTOMER_STG.C_CTRY_2, CUSTOMER_STG.C_AREA_2, CUSTOMER_STG.C_LOCAL_2, CUSTOMER_STG.C_EXT_2, CUSTOMER_STG.C_CTRY_3, CUSTOMER_STG.C_AREA_3, CUSTOMER_STG.C_LOCAL_3, CUSTOMER_STG.C_EXT_3, CUSTOMER_STG.C_EMAIL_1, CUSTOMER_STG.C_EMAIL_2, CUSTOMER_STG.C_LCL_TX_ID, CUSTOMER_STG.C_NAT_TX_ID, CURRENT_TIMESTAMP())"}
    );
  stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'CUSTOMER_ODS_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, $2 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit_stmt.execute();
  return 'Customer ODS records processed.';
  $$
;
