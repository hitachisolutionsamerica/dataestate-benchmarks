CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY_CALC_PE_RATIO_SP()
  returns string
  language javascript
  as
  $$
  // Process Fact Table
  var pe_stmt = snowflake.createStatement(
      {sqlText: "UPDATE TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY SET FACT_MARKET_HISTORY.PE_RATIO = FACT_MARKET_HISTORY.CLOSE_PRICE / ROLL_YEAR_EPS_CALC.ROLL_YEAR_EPS FROM (WITH MARKET_HISTORY_COMPANY_ID AS (SELECT FACT_MARKET_HISTORY.SK_SECURITY_ID, FACT_MARKET_HISTORY.SK_COMPANY_ID, FACT_MARKET_HISTORY.SK_DATE_ID, DIM_COMPANY.COMPANY_ID FROM TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY INNER JOIN TPCDI_WH.PUBLIC.DIM_COMPANY ON FACT_MARKET_HISTORY.SK_COMPANY_ID = DIM_COMPANY.SK_COMPANY_ID) SELECT  MARKET_HISTORY_COMPANY_ID.SK_SECURITY_ID, MARKET_HISTORY_COMPANY_ID.SK_COMPANY_ID, MARKET_HISTORY_COMPANY_ID.SK_DATE_ID, MARKET_HISTORY_COMPANY_ID.COMPANY_ID, DIM_FINANCIAL_ROLL_YEAR_EPS.ROLL_YEAR_EPS FROM MARKET_HISTORY_COMPANY_ID INNER JOIN TPCDI_WH.PUBLIC.DIM_FINANCIAL_ROLL_YEAR_EPS ON MARKET_HISTORY_COMPANY_ID.COMPANY_ID = DIM_FINANCIAL_ROLL_YEAR_EPS.COMPANY_ID AND YEAR(TO_DATE(MARKET_HISTORY_COMPANY_ID.SK_DATE_ID::STRING, 'YYYYMMDD')) || QUARTER(TO_DATE(MARKET_HISTORY_COMPANY_ID.SK_DATE_ID::STRING, 'YYYYMMDD')) = DIM_FINANCIAL_ROLL_YEAR_EPS.YEAR_QTR) ROLL_YEAR_EPS_CALC WHERE FACT_MARKET_HISTORY.SK_SECURITY_ID = ROLL_YEAR_EPS_CALC.SK_SECURITY_ID AND FACT_MARKET_HISTORY.SK_COMPANY_ID = ROLL_YEAR_EPS_CALC.SK_COMPANY_ID AND FACT_MARKET_HISTORY.SK_DATE_ID = ROLL_YEAR_EPS_CALC.SK_DATE_ID"}
    );
  pe_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'FACT_MARKET_HISTORY_CALC_PE_RATIO_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), 0, $1 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit_stmt.execute();
  return 'Fact Market History PE Ratio calculated.';
  $$
;
