CREATE OR REPLACE PROCEDURE TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY_TRANS_SP()
  returns string
  language javascript
  as
  $$
  // Process Fact Table
  var fact_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.FACT_MARKET_HISTORY SELECT DIM_SECURITY_NOW.SK_SECURITY_ID, DIM_SECURITY_NOW.SK_COMPANY_ID, DIM_DATE.DATE_ID, TO_NUMBER(-1), ((DIM_SECURITY_NOW.DIVIDEND / DM_CLOSE) * 100), TO_NUMBER(-1), TO_NUMBER(-1), TO_NUMBER(-1), TO_NUMBER(-1), DAILYMARKET_STG_STM.DM_CLOSE, DAILYMARKET_STG_STM.DM_HIGH, DAILYMARKET_STG_STM.DM_LOW, DAILYMARKET_STG_STM.DM_VOL, (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH) FROM TPCDI_STG.PUBLIC.DAILYMARKET_STG_STM INNER JOIN TPCDI_WH.PUBLIC.DIM_SECURITY_NOW ON DAILYMARKET_STG_STM.DM_S_SYMB = DIM_SECURITY_NOW.SYMBOL INNER JOIN TPCDI_WH.PUBLIC.DIM_DATE ON DAILYMARKET_STG_STM.DM_DATE = DIM_DATE.DATE_VALUE ORDER BY 3"}
    );
  fact_stmt.execute();
  // Log audit record
  var audit_stmt = snowflake.createStatement(
      {sqlText: "INSERT INTO TPCDI_WH.PUBLIC.AUDIT SELECT 'FACT_MARKET_HISTORY_TRANS_SP', LOCALTIMESTAMP(), (SELECT MAX(BATCH_ID) FROM TPCDI_WH.PUBLIC.CTRL_BATCH), $1, 0 FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))"}
    );
  audit_stmt.execute();
  return 'Fact Market History transactions inserted.';
  $$
;
