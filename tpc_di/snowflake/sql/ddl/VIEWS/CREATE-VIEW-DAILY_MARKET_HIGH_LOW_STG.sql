CREATE OR REPLACE VIEW TPCDI_STG.PUBLIC.DAILY_MARKET_HIGH_LOW_STG AS
WITH GET_HIGHS_LOWS AS (
SELECT
DM_S_SYMB SYMBOL,
DIM_DATE.DATE_ID DATE,
DM_HIGH DAY_HIGH,
DM_LOW DAY_LOW,
MAX(DM_HIGH) OVER (PARTITION BY DM_S_SYMB ORDER BY DM_DATE ROWS BETWEEN 364 PRECEDING AND CURRENT ROW) AS YEAR_HIGH,
MIN(DM_LOW) OVER (PARTITION BY DM_S_SYMB ORDER BY DM_DATE ROWS BETWEEN 364 PRECEDING AND CURRENT ROW) AS YEAR_LOW
FROM TPCDI_STG.PUBLIC.DAILYMARKET_STG
INNER JOIN TPCDI_WH.PUBLIC.DIM_DATE ON
	DAILYMARKET_STG.DM_DATE = DIM_DATE.DATE_VALUE
ORDER BY 1,2
)
SELECT
GET_HIGHS_LOWS.SYMBOL,
GET_HIGHS_LOWS.DATE,
GET_HIGHS_LOWS.DAY_HIGH,
GET_HIGHS_LOWS.YEAR_HIGH,
REPLACE(MIN(HIGH.DM_DATE)::STRING,'-')::NUMBER AS EARLIEST_HIGH_DATE,
GET_HIGHS_LOWS.DAY_LOW,
GET_HIGHS_LOWS.YEAR_LOW,
REPLACE(MIN(LOW.DM_DATE)::STRING,'-')::NUMBER AS EARLIEST_LOW_DATE
FROM GET_HIGHS_LOWS
INNER JOIN TPCDI_STG.PUBLIC.DAILYMARKET_STG HIGH
		ON HIGH.DM_S_SYMB = GET_HIGHS_LOWS.SYMBOL AND HIGH.DM_HIGH = GET_HIGHS_LOWS.YEAR_HIGH
INNER JOIN TPCDI_STG.PUBLIC.DAILYMARKET_STG LOW
		ON LOW.DM_S_SYMB = GET_HIGHS_LOWS.SYMBOL AND LOW.DM_LOW = GET_HIGHS_LOWS.YEAR_LOW
GROUP BY 1,2,3,4,6,7
ORDER BY 1,2
;