CREATE OR REPLACE TASK TPCDI_ODS.PUBLIC.FINWIRE_CMP_ODS_TSK
  WAREHOUSE = TASK_WH,
  SCHEDULE = '1 MINUTE'
AS
MERGE INTO TPCDI_ODS.PUBLIC.FINWIRE_CMP_ODS USING (
SELECT
    TO_TIMESTAMP_NTZ(PTS,'YYYYMMDD-HH24MISS') AS PTS
    ,REC_TYPE
    ,COMPANY_NAME
    ,CIK
    ,STATUS
    ,INDUSTRY_ID
    ,SP_RATING
    ,TRY_TO_DATE(FOUNDING_DATE) AS FOUNDING_DATE
    ,ADDR_LINE1
    ,ADDR_LINE2
    ,POSTAL_CODE
    ,CITY
    ,STATE_PROVINCE
    ,COUNTRY
    ,CEO_NAME
    ,DESCRIPTION
    ,METADATA$ACTION
    ,METADATA$ISUPDATE
FROM TPCDI_STG.PUBLIC.FINWIRE_STG_CMP_STM
WHERE REC_TYPE = 'CMP'
) FINWIRE_CMP_STG ON TPCDI_ODS.PUBLIC.FINWIRE_CMP_ODS.CIK = FINWIRE_CMP_STG.CIK
WHEN MATCHED THEN UPDATE SET
  FINWIRE_CMP_ODS.PTS = FINWIRE_CMP_STG.PTS
  ,FINWIRE_CMP_ODS.REC_TYPE = FINWIRE_CMP_STG.REC_TYPE
  ,FINWIRE_CMP_ODS.COMPANY_NAME = FINWIRE_CMP_STG.COMPANY_NAME
  ,FINWIRE_CMP_ODS.STATUS = FINWIRE_CMP_STG.STATUS
  ,FINWIRE_CMP_ODS.INDUSTRY_ID = FINWIRE_CMP_STG.INDUSTRY_ID
  ,FINWIRE_CMP_ODS.SP_RATING = FINWIRE_CMP_STG.SP_RATING
  ,FINWIRE_CMP_ODS.FOUNDING_DATE = FINWIRE_CMP_STG.FOUNDING_DATE
  ,FINWIRE_CMP_ODS.ADDR_LINE1 = FINWIRE_CMP_STG.ADDR_LINE1
  ,FINWIRE_CMP_ODS.ADDR_LINE2 = FINWIRE_CMP_STG.ADDR_LINE2
  ,FINWIRE_CMP_ODS.POSTAL_CODE = FINWIRE_CMP_STG.POSTAL_CODE
  ,FINWIRE_CMP_ODS.CITY = FINWIRE_CMP_STG.CITY
  ,FINWIRE_CMP_ODS.STATE_PROVINCE = FINWIRE_CMP_STG.STATE_PROVINCE
  ,FINWIRE_CMP_ODS.COUNTRY = FINWIRE_CMP_STG.COUNTRY
  ,FINWIRE_CMP_ODS.CEO_NAME = FINWIRE_CMP_STG.CEO_NAME
  ,FINWIRE_CMP_ODS.DESCRIPTION = FINWIRE_CMP_STG.DESCRIPTION
  ,FINWIRE_CMP_ODS.LAST_UPDATED_TS = CURRENT_TIMESTAMP()
WHEN NOT MATCHED THEN INSERT
VALUES
(
  FINWIRE_CMP_STG.PTS
  ,FINWIRE_CMP_STG.REC_TYPE
  ,FINWIRE_CMP_STG.COMPANY_NAME
  ,FINWIRE_CMP_STG.CIK
  ,FINWIRE_CMP_STG.STATUS
  ,FINWIRE_CMP_STG.INDUSTRY_ID
  ,FINWIRE_CMP_STG.SP_RATING
  ,FINWIRE_CMP_STG.FOUNDING_DATE
  ,FINWIRE_CMP_STG.ADDR_LINE1
  ,FINWIRE_CMP_STG.ADDR_LINE2
  ,FINWIRE_CMP_STG.POSTAL_CODE
  ,FINWIRE_CMP_STG.CITY
  ,FINWIRE_CMP_STG.STATE_PROVINCE
  ,FINWIRE_CMP_STG.COUNTRY
  ,FINWIRE_CMP_STG.CEO_NAME
  ,FINWIRE_CMP_STG.DESCRIPTION
  ,CURRENT_TIMESTAMP()
)
;

EXECUTE TASK TPCDI_ODS.PUBLIC.FINWIRE_CMP_ODS_TSK;
